<html>
<head>
	<meta charset="utf-8">
	<style>
	body {
		background-color: #44A;
	}

	.land {
	  fill: #250;
	  stroke: #232;
	  stroke-width: 1px;
	}

	.outline {
	  fill: none;
	}

	.circle {
	  fill: none;
	}

	.major {
	  stroke-dasharray:none;
	  stroke-width: 1px;
	}
	</style>
	<script src="./d3.min.js"></script>
	<script src="./topojson.min.js"></script>
	<script src="world.js"></script>
</head>
<body>
	<div id="map"></div>
	<script>
	const TO_DEG = 180 / Math.PI;
	const LAND = topojson.feature(world, world.objects.land);
	const ASIMEQ_TRANSF = d3.geo
				.azimuthalEquidistant()
				.translate([500, 500])
				.scale(140)
				.clipAngle(175)
				.precision(.1)

	let moving = 0;
	let currLat = 0; /* -90 > 90 N/S */
	let currLng = 0; /*-180 > 180 E/O */

	function xyzToLatlng(xyz) {
		return [
			90 - (Math.acos(xyz[1] / Math.sqrt(xyz[0]*xyz[0]+xyz[1]*xyz[1]+xyz[2]*xyz[2]))) * TO_DEG,
			((270 + (Math.atan2(xyz[0] , xyz[2])) * TO_DEG) % 360) -180
		];
	}
	function latlngToXyz(lat, lng) {
		lat/=TO_DEG;
		lng/=TO_DEG;
		return [
			-Math.cos(lat) * Math.cos(lng),
			Math.sin(lat),
			Math.cos(lat) * Math.sin(lng),
		];
	}

	function goToPath(data) {
		const p=()=>{
			const d = data.shift();
			if(d) {
				goTo(d[0],d[1],d[2], p)
			}
		}
		p();
	}

	function goTo(dirLat,dirLng,stN,cb) {
		if((stN|=0)<=0)
			return;

		goTo2(latlngToXyz(currLat, currLng),
		latlngToXyz(dirLat,dirLng),1,stN,cb);
	}
	function goTo2(beg,dir,st,stN,cb) {
		if(st<=0||st>=stN) {
			moveTo(xyzToLatlng(dir));
			return cb&&cb()||true;
		}

		const nd = stN-st;
		let next = xyzToLatlng([
			(beg[0]*nd+dir[0]*st)/stN,
			(beg[1]*nd+dir[1]*st)/stN,
			(beg[2]*nd+dir[2]*st)/stN,
		]);


		setTimeout(()=>{
			moveTo(next);
			goTo2(beg,dir,st+1,stN,cb);
		}, 25);
	}

	function reset() {
		document.getElementById('map').innerHTML = ''; // reset
		const svg = d3.selectAll('#map').data([ASIMEQ_TRANSF]).append('svg');
		svg.each(project);

		let g = svg.append('g');
		g.append('path').datum(LAND).attr('class', 'land');
		g.append('path').attr('id', 'actu');
		d3.geo.path().pointRadius(1);
		moveTo([90,0]);
	}
	function moveTo(latlng) {
		ASIMEQ_TRANSF.rotate([-latlng[1], -latlng[0]]);
		d3.select('#actu').datum({type: 'Point', coordinates: [latlng[1], latlng[0]]});
		d3.select('g').each(redraw);
		currLat = latlng[0];
		currLng = latlng[1];
	}

	function redraw(p) {
	  d3.select(this).selectAll('path').attr('d', d3.geo.path().projection(p));
	}
	function project(p) {
	  const t = p.translate();
	  d3.select(this).attr('width', 2 * t[0]).attr('height', 2 * t[1]);
	}

	reset();
	/**/
	</script>
	<button onclick="goToPath([
	//   lat    lng     steps(1=25ms)
		[43.5,	7,		10], // Vallauris
		[43.75,	7.25,	10], // Nice
		[48.9,	2.4,	30], // Paris
		[35.6,	139.6,	200], // Tokyo
		[33.4,	130.3,	30], // Fukuoka
		[35.6,	139.6,	200], // Tokyo
		[48.9,	2.4,	200], // Paris
		[43.75,	7.25,	30], // Nice
		[43.5,	7,		10], // Vallauris
	]);" >Show trip</button>
</body>
</html>
